<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyro Admin | Edit Question</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: {
                            primary: '#0a0e17',
                            secondary: '#141824',
                            tertiary: '#1d2230',
                        },
                        accent: {
                            teal: '#1ab69d',
                            orange: '#ff6b35',
                            red: '#ef4444',
                            purple: '#8b5cf6',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-bg-primary text-gray-200 font-sans min-h-screen flex">

    <%- include('sidebar', { page: 'nbt' }) %>

        <!-- Main Content -->
        <div class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center gap-4 mb-8">
                    <a href="/admin/nbt/edit/<%= testId %>"
                        class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:bg-white/10 transition-all">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-3xl font-bold text-white tracking-tight">Edit Question</h1>
                </div>

                <div
                    class="bg-bg-secondary/50 backdrop-blur-sm border border-white/5 rounded-2xl p-6 shadow-xl relative">

                    <form action="/admin/nbt/update-question/<%= testId %>/<%= questionIndex %>" method="POST"
                        class="space-y-6">

                        <!-- Question Content Builder -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-gray-300">Question Content</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="addQuestionBlock('text')"
                                        class="text-xs bg-accent-teal/10 hover:bg-accent-teal/20 text-accent-teal px-3 py-1.5 rounded-lg transition-all border border-accent-teal/20">
                                        <i class="fas fa-text mr-1"></i> Add Text/LaTeX
                                    </button>
                                    <button type="button" onclick="addQuestionBlock('image')"
                                        class="text-xs bg-accent-purple/10 hover:bg-accent-purple/20 text-accent-purple px-3 py-1.5 rounded-lg transition-all border border-accent-purple/20">
                                        <i class="fas fa-image mr-1"></i> Add Image
                                    </button>
                                </div>
                            </div>

                            <div id="questionContentBlocks" class="space-y-3">
                                <!-- Initial question text block -->
                                <div class="content-block bg-bg-tertiary/50 border border-white/10 rounded-xl p-4"
                                    data-type="text">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-medium text-gray-500 uppercase"><i
                                                class="fas fa-text mr-1"></i> Text Block</span>
                                        <button type="button" onclick="removeBlock(this)"
                                            class="text-gray-500 hover:text-red-400 transition-colors">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <textarea name="questionContent[]" rows="3" required
                                        oninput="updateQuestionPreview()"
                                        class="w-full bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-accent-teal/50 font-mono"
                                        placeholder="Enter text or LaTeX (use $ for inline math, $$ for display math)"><%= question.questionText %></textarea>
                                    <input type="hidden" name="questionContentType[]" value="text">
                                </div>
                            </div>

                            <!-- Question Preview -->
                            <div class="bg-white/5 border border-white/10 rounded-xl p-4">
                                <div class="text-xs font-medium text-gray-500 uppercase mb-2"><i
                                        class="fas fa-eye mr-1"></i> Question Preview</div>
                                <div id="questionPreview" class="text-gray-200 min-h-[60px]">Preview will appear here...
                                </div>
                            </div>
                        </div>

                        <!-- Answer Options -->
                        <div class="space-y-4">
                            <label class="text-sm font-bold text-gray-300">Answer Options</label>

                            <% for(let i=0; i<4; i++) { %>
                                <div class="bg-bg-tertiary/30 border border-white/10 rounded-xl p-4">
                                    <div class="flex gap-3 items-start mb-3">
                                        <input type="radio" name="correctOptionIndex" value="<%= i %>"
                                            <%=question.correctOptionIndex===i ? 'checked' : '' %>
                                        class="accent-accent-teal w-4 h-4 mt-3 cursor-pointer shrink-0">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium text-gray-400">Option <%=
                                                        String.fromCharCode(65 + i) %></span>
                                                <div class="flex gap-2">
                                                    <button type="button" onclick="addOptionBlock(<%= i %>, 'text')"
                                                        class="text-xs bg-accent-teal/10 hover:bg-accent-teal/20 text-accent-teal px-2 py-1 rounded transition-all">
                                                        <i class="fas fa-text"></i>
                                                    </button>
                                                    <button type="button" onclick="addOptionBlock(<%= i %>, 'image')"
                                                        class="text-xs bg-accent-purple/10 hover:bg-accent-purple/20 text-accent-purple px-2 py-1 rounded transition-all">
                                                        <i class="fas fa-image"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div id="optionBlocks<%= i %>" class="space-y-2">
                                                <!-- Initial option text -->
                                                <div class="content-block" data-type="text">
                                                    <textarea name="options[<%= i %>][]" rows="2" required
                                                        oninput="updateOptionPreview(<%= i %>)"
                                                        class="w-full bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-accent-teal/50 font-mono"
                                                        placeholder="Enter option text or LaTeX"><%= question.options[i] %></textarea>
                                                    <input type="hidden" name="optionsType[<%= i %>][]" value="text">
                                                </div>
                                            </div>

                                            <!-- Option Preview -->
                                            <div id="optionPreview<%= i %>"
                                                class="mt-2 p-2 bg-white/5 rounded-lg text-gray-300 text-sm min-h-[40px]">
                                                Preview...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% } %>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit"
                                class="flex-1 bg-accent-teal hover:bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all">
                                <i class="fas fa-save mr-2"></i> Update Question
                            </button>
                            <a href="/admin/nbt/edit/<%= testId %>"
                                class="px-6 py-3 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white rounded-xl transition-all text-center font-medium">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <script>
            let blockCounter = 0;

            // Add question content block
            function addQuestionBlock(type) {
                const container = document.getElementById('questionContentBlocks');
                const block = document.createElement('div');
                block.className = 'content-block bg-bg-tertiary/50 border border-white/10 rounded-xl p-4 animate-fade-in';
                block.dataset.type = type;
                blockCounter++;

                if (type === 'text') {
                    block.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-medium text-gray-500 uppercase"><i class="fas fa-text mr-1"></i> Text Block</span>
                            <button type="button" onclick="removeBlock(this)" class="text-gray-500 hover:text-red-400 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea name="questionContent[]" rows="3"
                            oninput="updateQuestionPreview()"
                            class="w-full bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-accent-teal/50 font-mono"
                            placeholder="Enter text or LaTeX (use $ for inline math, $$ for display math)"></textarea>
                        <input type="hidden" name="questionContentType[]" value="text">
                    `;
                } else if (type === 'image') {
                    block.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-medium text-gray-500 uppercase"><i class="fas fa-image mr-1"></i> Image Block</span>
                            <button type="button" onclick="removeBlock(this)" class="text-gray-500 hover:text-red-400 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <input type="url" name="questionContent[]"
                            oninput="updateQuestionPreview()"
                            class="w-full bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-accent-teal/50"
                            placeholder="Enter image URL (https://...)">
                        <input type="hidden" name="questionContentType[]" value="image">
                        <p class="text-xs text-gray-500 mt-1">Paste a direct image URL</p>
                    `;
                }

                container.appendChild(block);
                updateQuestionPreview();
            }

            // Add option content block
            function addOptionBlock(optionIndex, type) {
                const container = document.getElementById(`optionBlocks${optionIndex}`);
                const block = document.createElement('div');
                block.className = 'content-block animate-fade-in';
                block.dataset.type = type;

                if (type === 'text') {
                    block.innerHTML = `
                        <div class="flex gap-2 items-start">
                            <textarea name="options[${optionIndex}][]" rows="2"
                                oninput="updateOptionPreview(${optionIndex})"
                                class="flex-1 bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-accent-teal/50 font-mono"
                                placeholder="Additional text or LaTeX"></textarea>
                            <button type="button" onclick="removeBlock(this)" class="text-gray-500 hover:text-red-400 transition-colors mt-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <input type="hidden" name="optionsType[${optionIndex}][]" value="text">
                    `;
                } else if (type === 'image') {
                    block.innerHTML = `
                        <div class="flex gap-2 items-start">
                            <input type="url" name="options[${optionIndex}][]"
                                oninput="updateOptionPreview(${optionIndex})"
                                class="flex-1 bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-accent-teal/50"
                                placeholder="Image URL (https://...)">
                            <button type="button" onclick="removeBlock(this)" class="text-gray-500 hover:text-red-400 transition-colors mt-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <input type="hidden" name="optionsType[${optionIndex}][]" value="image">
                    `;
                }

                container.appendChild(block);
                updateOptionPreview(optionIndex);
            }

            // Remove block
            function removeBlock(button) {
                const block = button.closest('.content-block');
                const isQuestionBlock = block.closest('#questionContentBlocks');
                const isOptionBlock = block.closest('[id^="optionBlocks"]');

                // Prevent removing the last block in question or options
                if (isQuestionBlock) {
                    const totalBlocks = document.querySelectorAll('#questionContentBlocks .content-block').length;
                    if (totalBlocks <= 1) {
                        alert('You must have at least one content block for the question.');
                        return;
                    }
                }

                if (isOptionBlock) {
                    const optionContainer = block.closest('[id^="optionBlocks"]');
                    const totalBlocks = optionContainer.querySelectorAll('.content-block').length;
                    if (totalBlocks <= 1) {
                        alert('You must have at least one content block for each option.');
                        return;
                    }
                }

                block.remove();

                if (isQuestionBlock) {
                    updateQuestionPreview();
                } else if (isOptionBlock) {
                    const optionIndex = parseInt(block.closest('[id^="optionBlocks"]').id.replace('optionBlocks', ''));
                    updateOptionPreview(optionIndex);
                }
            }

            // Update question preview
            function updateQuestionPreview() {
                const preview = document.getElementById('questionPreview');
                const blocks = document.querySelectorAll('#questionContentBlocks .content-block');
                let html = '';

                blocks.forEach(block => {
                    const type = block.dataset.type;
                    if (type === 'text') {
                        const textarea = block.querySelector('textarea');
                        if (textarea && textarea.value) {
                            html += `<div class="mb-3">${textarea.value.replace(/\n/g, '<br>')}</div>`;
                        }
                    } else if (type === 'image') {
                        const input = block.querySelector('input[type="url"]');
                        if (input && input.value) {
                            html += `<div class="mb-3"><img src="${input.value}" class="max-w-full max-h-64 rounded-lg border border-white/10" onerror="this.parentElement.innerHTML='<span class=\\'text-red-400 text-xs\\'>Invalid image URL</span>'"></div>`;
                        }
                    }
                });

                preview.innerHTML = html || 'Preview will appear here...';

                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).catch((err) => console.log(err));
                }
            }

            // Update option preview
            function updateOptionPreview(optionIndex) {
                const preview = document.getElementById(`optionPreview${optionIndex}`);
                const blocks = document.querySelectorAll(`#optionBlocks${optionIndex} .content-block`);
                let html = '';

                blocks.forEach(block => {
                    const type = block.dataset.type;
                    if (type === 'text') {
                        const textarea = block.querySelector('textarea');
                        if (textarea && textarea.value) {
                            html += `<div class="mb-2">${textarea.value.replace(/\n/g, '<br>')}</div>`;
                        }
                    } else if (type === 'image') {
                        const input = block.querySelector('input[type="url"]');
                        if (input && input.value) {
                            html += `<div class="mb-2"><img src="${input.value}" class="max-w-full max-h-32 rounded border border-white/10" onerror="this.parentElement.innerHTML='<span class=\\'text-red-400 text-xs\\'>Invalid image URL</span>'"></div>`;
                        }
                    }
                });

                preview.innerHTML = html || 'Preview...';

                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).catch((err) => console.log(err));
                }
            }

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", () => {
                updateQuestionPreview();
                for (let i = 0; i < 4; i++) {
                    updateOptionPreview(i);
                }

                if (window.MathJax) {
                    MathJax.typesetPromise();
                }
            });

            // Add fade-in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in {
                    animation: fadeIn 0.3s ease-out;
                }
            `;
            document.head.appendChild(style);
        </script>
</body>

</html>
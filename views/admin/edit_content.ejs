<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyro Admin | Edit Question</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: {
                            primary: '#0a0e17',
                            secondary: '#141824',
                            tertiary: '#1d2230',
                        },
                        accent: {
                            teal: '#1ab69d',
                            orange: '#ff6b35',
                            purple: '#8b5cf6',
                            green: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-bg-primary text-gray-200 font-sans min-h-screen flex">

    <%- include('sidebar', { page: 'content' }) %>

        <!-- Main Content -->
        <div class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-white tracking-tight">Edit Question</h1>
                    <a href="/admin/content"
                        class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-xl transition-all text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Cancel
                    </a>
                </div>

                <div class="bg-bg-secondary/50 backdrop-blur-sm border border-white/5 rounded-2xl p-8 shadow-xl">
                    <form action="/admin/content/update/<%= question._id %>" method="POST" enctype="multipart/form-data"
                        class="space-y-6">

                        <!-- Paper & Topic Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-400">Paper</label>
                                <select name="paper" id="paperSelect" required onchange="updateTopics()"
                                    class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                    <option value="Paper 1" <%=question.paper==='Paper 1' ? 'selected' : '' %>>Paper 1
                                    </option>
                                    <option value="Paper 2" <%=question.paper==='Paper 2' ? 'selected' : '' %>>Paper 2
                                    </option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-400">Topic</label>
                                <!-- Will be populated by JS, we set data attribute for initial value -->
                                <select name="topic" id="topicSelect" required data-initial="<%= question.topic %>"
                                    class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                </select>
                            </div>
                        </div>

                        <!-- Question Number & Difficulty -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-400">Question Number</label>
                                <input type="text" name="questionNumber" value="<%= question.questionNumber %>" required
                                    class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-400">Difficulty</label>
                                <select name="difficulty"
                                    class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                    <option value="easy" <%=question.difficulty==='easy' ? 'selected' : '' %>>Easy
                                    </option>
                                    <option value="medium" <%=question.difficulty==='medium' ? 'selected' : '' %>>Medium
                                    </option>
                                    <option value="hard" <%=question.difficulty==='hard' ? 'selected' : '' %>>Hard
                                    </option>
                                    <option value="expert" <%=question.difficulty==='expert' ? 'selected' : '' %>>Expert
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Image Upload -->
                        <div class="space-y-3 bg-white/5 rounded-xl p-4 border border-white/5">
                            <label class="text-sm font-bold text-gray-300 block mb-2">Image Source</label>

                            <% if (question.imageUrl) { %>
                                <div class="mb-4 p-2 bg-black/20 rounded-lg border border-white/5">
                                    <p class="text-xs text-gray-500 mb-2">Current Image:</p>
                                    <img src="<%= question.imageUrl %>" class="max-h-32 object-contain rounded">
                                </div>
                                <% } %>

                                    <div class="flex gap-6 mb-4">
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <div
                                                class="relative flex items-center justify-center w-5 h-5 rounded-full border border-gray-500 group-hover:border-accent-teal transition-all">
                                                <input type="radio" name="imgSourceType" value="keep" checked
                                                    onchange="toggleImageSource(this.value)"
                                                    class="peer opacity-0 absolute">
                                                <div
                                                    class="w-2.5 h-2.5 rounded-full bg-accent-teal opacity-0 peer-checked:opacity-100 transition-opacity">
                                                </div>
                                            </div>
                                            <span
                                                class="text-sm text-gray-400 group-hover:text-white transition-colors">Keep
                                                Current</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <div
                                                class="relative flex items-center justify-center w-5 h-5 rounded-full border border-gray-500 group-hover:border-accent-teal transition-all">
                                                <input type="radio" name="imgSourceType" value="url"
                                                    onchange="toggleImageSource(this.value)"
                                                    class="peer opacity-0 absolute">
                                                <div
                                                    class="w-2.5 h-2.5 rounded-full bg-accent-teal opacity-0 peer-checked:opacity-100 transition-opacity">
                                                </div>
                                            </div>
                                            <span
                                                class="text-sm text-gray-400 group-hover:text-white transition-colors">New
                                                URL</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <div
                                                class="relative flex items-center justify-center w-5 h-5 rounded-full border border-gray-500 group-hover:border-accent-teal transition-all">
                                                <input type="radio" name="imgSourceType" value="upload"
                                                    onchange="toggleImageSource(this.value)"
                                                    class="peer opacity-0 absolute">
                                                <div
                                                    class="w-2.5 h-2.5 rounded-full bg-accent-teal opacity-0 peer-checked:opacity-100 transition-opacity">
                                                </div>
                                            </div>
                                            <span
                                                class="text-sm text-gray-400 group-hover:text-white transition-colors">Upload
                                                New</span>
                                        </label>
                                    </div>

                                    <div id="img-url-input" class="hidden">
                                        <input type="url" name="imageUrl" placeholder="https://example.com/image.png"
                                            class="w-full bg-bg-primary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all">
                                    </div>

                                    <div id="img-upload-input" class="hidden">
                                        <input type="file" name="imageFile" accept="image/*"
                                            class="w-full bg-bg-primary border border-white/10 rounded-xl px-4 py-3 text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-accent-teal/10 file:text-accent-teal hover:file:bg-accent-teal/20 transition-all">
                                    </div>
                        </div>

                        <!-- Question Text -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-400 flex justify-between">
                                <span>Question Text</span>
                                <span class="text-xs text-gray-600">LaTeX Supported</span>
                            </label>
                            <textarea name="questionText" id="questionText" rows="4" required
                                oninput="updatePreview('questionText', 'questionPreview')"
                                class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all font-mono text-sm"><%= question.questionText %></textarea>
                            <div id="questionPreview"
                                class="min-h-[60px] p-4 rounded-xl bg-white/5 border border-white/10 text-gray-300 text-sm">
                                <%= question.questionText %>
                            </div>
                        </div>

                        <!-- Dynamic Fields -->
                        <div class="space-y-4">
                            <label class="text-sm font-medium text-gray-400">Additional Options</label>
                            <div id="dynamic-fields-container" class="space-y-3">
                                <% if (question.additionalFields && question.additionalFields.length> 0) { %>
                                    <% question.additionalFields.forEach((field, i)=> { %>
                                        <div class="flex gap-3 items-center">
                                            <input type="text" name="additionalFields[<%= i %>][label]"
                                                value="<%= field.label %>" placeholder="Label"
                                                class="w-1/3 bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-accent-teal/50">
                                            <input type="text" name="additionalFields[<%= i %>][value]"
                                                value="<%= field.value %>" placeholder="Value"
                                                class="w-full bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-accent-teal/50">
                                            <button type="button" onclick="this.parentElement.remove()"
                                                class="text-red-400 hover:text-red-300 p-2 transition-colors"><i
                                                    class="fas fa-times"></i></button>
                                        </div>
                                        <% }) %>
                                            <% } %>
                            </div>
                            <button type="button" onclick="addDynamicField()"
                                class="text-xs font-semibold text-accent-teal bg-accent-teal/10 hover:bg-accent-teal/20 px-4 py-2 rounded-lg transition-all border border-accent-teal/20">
                                <i class="fas fa-plus mr-1"></i> Add Option Field
                            </button>
                        </div>

                        <!-- Answer & Timer -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-400">Correct Answer</label>
                                <textarea name="answer" id="answer" required
                                    oninput="updatePreview('answer', 'answerPreview')"
                                    class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all font-mono text-sm h-32"><%= question.answer %></textarea>
                                <div id="answerPreview"
                                    class="min-h-[60px] p-4 rounded-xl bg-white/5 border border-white/10 text-gray-300 text-sm">
                                    <%= question.answer %>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-400">Timer (seconds)</label>
                                <input type="number" name="timer" value="<%= question.timer %>"
                                    class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all">
                            </div>
                        </div>

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-accent-purple to-purple-600 hover:from-purple-400 hover:to-purple-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-accent-purple/20 hover:shadow-accent-purple/40 transform hover:-translate-y-0.5 transition-all duration-200">
                            Update Question
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <script>
            const topics = {
                'Paper 1': [
                    'Algebra, Equations, and Inequalities',
                    'Patterns & Geometric Series',
                    'Functions and Graphs',
                    'Financial Mathematics',
                    'Calculus',
                    'Probability',
                    'Counting Principles',
                    'Advanced Functions'
                ],
                'Paper 2': [
                    'Statistics',
                    'Analytical Geometry',
                    'Trigonometry',
                    'Euclidean Geometry'
                ]
            };

            function updateTopics() {
                const paperSelect = document.getElementById('paperSelect');
                const topicSelect = document.getElementById('topicSelect');
                const selectedPaper = paperSelect.value;
                const initialTopic = topicSelect.getAttribute('data-initial');

                topicSelect.innerHTML = '<option value="" disabled>Select Topic</option>';

                if (topics[selectedPaper]) {
                    topics[selectedPaper].forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic;
                        if (topic === initialTopic) {
                            option.selected = true;
                        }
                        topicSelect.appendChild(option);
                    });
                }
            }

            // Initialize topics on load
            window.addEventListener('DOMContentLoaded', updateTopics);

            function addDynamicField() {
                const container = document.getElementById('dynamic-fields-container');
                const index = container.children.length; // This index strategy might fail if elements are deleted and re-added but standard form submission handles indices loosely or uses array push.
                // Using timestamp specific index or just incrementing might be safer but for MVP array index is fine if we reconstruct carefully.
                // Mongoose handles arrays of objects fine usually without explicit index keys if name="additionalFields[i][prop]" format is preserved.
                // To be safe we should querySelectorAll length for new index.

                const div = document.createElement('div');
                div.className = 'flex gap-3 items-center animate-fade-in';
                div.innerHTML = `
                <input type="text" name="additionalFields[${index}][label]" placeholder="Label" class="w-1/3 bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-accent-teal/50">
                <input type="text" name="additionalFields[${index}][value]" placeholder="Value" class="w-full bg-bg-primary border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-accent-teal/50">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 p-2 transition-colors"><i class="fas fa-times"></i></button>
            `;
                container.appendChild(div);
            }

            function toggleImageSource(type) {
                const urlInput = document.getElementById('img-url-input');
                const uploadInput = document.getElementById('img-upload-input');

                urlInput.classList.add('hidden');
                uploadInput.classList.add('hidden');

                if (type === 'upload') {
                    uploadInput.classList.remove('hidden');
                } else if (type === 'url') {
                    urlInput.classList.remove('hidden');
                }
                // 'keep' does nothing (both hidden)
            }

            function updatePreview(inputId, previewId) {
                const input = document.getElementById(inputId).value;
                const preview = document.getElementById(previewId);

                preview.innerHTML = input.replace(/\n/g, '<br>');

                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).catch((err) => console.log(err));
                }
            }

            // Initial preview render
            window.addEventListener('load', () => {
                if (window.MathJax) {
                    MathJax.typesetPromise().catch((err) => console.log(err));
                }
            });
        </script>
</body>

</html>
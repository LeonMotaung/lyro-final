<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyro Admin | Content</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: {
                            primary: '#0a0e17',
                            secondary: '#141824',
                            tertiary: '#1d2230',
                        },
                        accent: {
                            teal: '#1ab69d',
                            orange: '#ff6b35',
                            purple: '#8b5cf6',
                            green: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-bg-primary text-gray-200 font-sans min-h-screen flex">

    <%- include('sidebar', { page: 'content' }) %>

        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6 md:mb-8">
                    <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight">Content Management</h1>
                </div>

                <% if (typeof success !=='undefined' && success) { %>
                    <div
                        class="bg-green-500/10 border border-green-500/20 text-green-400 px-4 py-3 rounded-xl mb-6 flex items-center gap-2 animate-fade-in">
                        <i class="fas fa-check-circle"></i>
                        <span>Question saved successfully!</span>
                    </div>
                    <% } %>

                        <!-- Add New Question Form -->
                        <div
                            class="bg-bg-secondary/50 backdrop-blur-sm border border-white/5 rounded-2xl p-4 md:p-8 shadow-xl mb-8">
                            <h2 class="text-lg md:text-xl font-bold text-white mb-6 flex items-center gap-2">
                                <i class="fas fa-plus-circle text-accent-teal"></i> Add New Question
                            </h2>

                            <form action="/admin/content/create" method="POST" enctype="multipart/form-data"
                                class="space-y-6">

                                <!-- Grade & Subject Selection -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-400">Grade</label>
                                        <select name="grade" id="gradeSelect" required onchange="filterSubjects()"
                                            class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                            <option value="" disabled selected>Select Grade</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-400">Subject</label>
                                        <select name="subject" id="subjectSelect" required onchange="filterTopics()"
                                            class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                            <option value="" disabled selected>Select Grade First</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Paper & Topic Selection -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-400">Paper</label>
                                        <select name="paper" id="paperSelect" required
                                            class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                            <option value="" disabled selected>Select Paper</option>
                                            <option value="Paper 1">Paper 1</option>
                                            <option value="Paper 2">Paper 2</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-400">Topic</label>
                                        <select name="topic" id="topicSelect" required
                                            class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                            <option value="" disabled selected>Select Subject First</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Question Number & Difficulty -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-400">Question Number</label>
                                        <input type="text" name="questionNumber" required placeholder="e.g., 1.1"
                                            class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gray-400">Difficulty</label>
                                        <select name="difficulty" required
                                            class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all appearance-none cursor-pointer">
                                            <option value="Easy">Easy</option>
                                            <option value="Medium" selected>Medium</option>
                                            <option value="Hard">Hard</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Question Text -->
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-400">Question Text</label>
                                    <textarea name="questionText" rows="4" required
                                        placeholder="Enter question text (supports LaTeX)"
                                        class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all resize-none"></textarea>
                                </div>

                                <!-- Answer -->
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-400">Answer</label>
                                    <textarea name="answer" rows="3" required placeholder="Enter the correct answer"
                                        class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all resize-none"></textarea>
                                </div>

                                <!-- Timer -->
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-400">Timer (seconds)</label>
                                    <input type="number" name="timer" value="120" min="30" max="600"
                                        class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-teal/50 focus:ring-1 focus:ring-accent-teal/50 transition-all">
                                </div>

                                <!-- Image Upload -->
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-gray-400">Question Image (Optional)</label>
                                    <input type="file" name="imageFile" accept="image/*"
                                        class="w-full bg-bg-tertiary border border-white/10 rounded-xl px-4 py-3 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-accent-teal file:text-white hover:file:bg-accent-teal/80 transition-all">
                                </div>

                                <!-- Submit Button -->
                                <div class="flex justify-end pt-4">
                                    <button type="submit"
                                        class="bg-gradient-to-r from-accent-teal to-teal-600 hover:from-teal-400 hover:to-teal-500 text-white font-bold px-8 py-3 rounded-xl shadow-lg shadow-accent-teal/20 hover:shadow-accent-teal/40 transform hover:-translate-y-0.5 transition-all duration-200">
                                        <i class="fas fa-save mr-2"></i> Save Question
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Existing Questions List -->
                        <div
                            class="bg-bg-secondary/50 backdrop-blur-sm border border-white/5 rounded-2xl overflow-hidden shadow-xl">
                            <div class="p-4 md:p-6 border-b border-white/5">
                                <h2 class="text-lg md:text-xl font-bold text-white flex items-center gap-2">
                                    <i class="fas fa-list text-accent-purple"></i> Existing Questions
                                </h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="border-b border-white/5 bg-white/5">
                                            <th
                                                class="p-3 md:p-4 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                                Grade</th>
                                            <th
                                                class="p-3 md:p-4 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                                Subject</th>
                                            <th
                                                class="p-3 md:p-4 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                                Topic</th>
                                            <th
                                                class="p-3 md:p-4 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                                Q#</th>
                                            <th
                                                class="p-3 md:p-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">
                                                Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-white/5">
                                        <% if (questions && questions.length> 0) { %>
                                            <% questions.forEach(q=> { %>
                                                <tr class="hover:bg-white/5 transition-colors">
                                                    <td class="p-3 md:p-4 text-white text-sm">Grade <%= q.grade || 12 %>
                                                    </td>
                                                    <td class="p-3 md:p-4 text-gray-300 text-sm">
                                                        <%= q.subject || 'N/A' %>
                                                    </td>
                                                    <td class="p-3 md:p-4 text-accent-teal text-sm">
                                                        <%= q.topic %>
                                                    </td>
                                                    <td class="p-3 md:p-4 text-white font-mono text-sm">
                                                        <%= q.questionNumber %>
                                                    </td>
                                                    <td class="p-3 md:p-4 text-right">
                                                        <div class="flex justify-end gap-2">
                                                            <a href="/admin/content/edit/<%= q._id %>"
                                                                class="bg-white/5 hover:bg-accent-teal hover:text-white text-gray-400 p-2 rounded-lg transition-all text-xs">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <form action="/admin/content/delete/<%= q._id %>"
                                                                method="POST"
                                                                onsubmit="return confirm('Delete this question?');"
                                                                class="inline">
                                                                <button type="submit"
                                                                    class="bg-white/5 hover:bg-red-500 hover:text-white text-gray-400 p-2 rounded-lg transition-all text-xs">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="5" class="p-8 text-center text-gray-500">
                                                                <i class="fas fa-inbox text-4xl mb-2 opacity-20"></i>
                                                                <p>No questions found. Add your first question above!
                                                                </p>
                                                            </td>
                                                        </tr>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>

            </div>
        </div>

        <script>
            // Server-side data passed to client
            const serverSubjects = <% - JSON.stringify(subjects || []) %>;
            const serverTopics = <% - JSON.stringify(topics || []) %>;

            function filterSubjects() {
                const grade = parseInt(document.getElementById('gradeSelect').value);
                const subjectSelect = document.getElementById('subjectSelect');
                const topicSelect = document.getElementById('topicSelect');

                // Clear previous options
                subjectSelect.innerHTML = '<option value="" disabled selected>Loading subjects...</option>';
                topicSelect.innerHTML = '<option value="" disabled selected>Select Subject First</option>';

                if (!grade) {
                    subjectSelect.innerHTML = '<option value="" disabled selected>Select Grade First</option>';
                    return;
                }

                // Filter subjects by selected grade
                const filteredSubjects = serverSubjects.filter(s => s.grade == grade);

                // Repopulate subject dropdown
                subjectSelect.innerHTML = '<option value="" disabled selected>Select Subject</option>';
                if (filteredSubjects.length === 0) {
                    subjectSelect.innerHTML = '<option value="" disabled>No subjects found for this grade</option>';
                } else {
                    filteredSubjects.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.name;
                        option.dataset.subjectId = sub._id;  // Store subject ID
                        option.textContent = sub.name;
                        subjectSelect.appendChild(option);
                    });
                }
            }

            function filterTopics() {
                const subjectSelect = document.getElementById('subjectSelect');
                const topicSelect = document.getElementById('topicSelect');

                const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
                const subjectId = selectedOption?.dataset.subjectId;

                // Clear topics
                topicSelect.innerHTML = '<option value="" disabled selected>Loading topics...</option>';

                if (!subjectId) {
                    topicSelect.innerHTML = '<option value="" disabled selected>Select Subject First</option>';
                    return;
                }

                // Filter topics by subject ID (most reliable)
                const filteredTopics = serverTopics.filter(t =>
                    t.subject &&
                    (t.subject._id || t.subject).toString() === subjectId
                );

                // Repopulate topics
                topicSelect.innerHTML = '<option value="" disabled selected>Select Topic</option>';
                if (filteredTopics.length === 0) {
                    topicSelect.innerHTML += '<option value="" disabled>No topics found</option>';
                } else {
                    filteredTopics.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.name;
                        option.textContent = t.name;
                        topicSelect.appendChild(option);
                    });
                }
            }

            // Optional: Auto-trigger if page loads with pre-selected values (e.g., edit mode)
            document.addEventListener('DOMContentLoaded', () => {
                const gradeSelect = document.getElementById('gradeSelect');
                if (gradeSelect.value) {
                    filterSubjects();
                    setTimeout(() => {
                        const subjectSelect = document.getElementById('subjectSelect');
                        if (subjectSelect.value) filterTopics();
                    }, 100);
                }
            });
        </script>
</body>

</html>
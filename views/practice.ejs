<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyro Maths | Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: {
                            primary: 'rgb(var(--bg-primary) / <alpha-value>)',
                            secondary: 'rgb(var(--bg-secondary) / <alpha-value>)',
                            tertiary: 'rgb(var(--bg-tertiary) / <alpha-value>)',
                            card: 'rgb(var(--bg-card) / <alpha-value>)',
                        },
                        app: {
                            text: 'rgb(var(--text-primary) / <alpha-value>)',
                            muted: 'rgb(var(--text-muted) / <alpha-value>)',
                        },
                        accent: {
                            teal: '#1ab69d',
                            orange: '#ff6b35',
                            purple: '#8b5cf6',
                            green: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-primary: 10 14 23;
            /* #0a0e17 */
            --bg-secondary: 20 24 36;
            /* #141824 */
            --bg-tertiary: 29 34 48;
            /* #1d2230 */
            --bg-card: 30 35 45;
            /* #1e232d */

            --text-primary: 255 255 255;
            --text-muted: 255 255 255;
            /* Opacity handled by class */
        }

        [data-theme="light"] {
            /* Light Theme */
            --bg-primary: 241 245 249;
            /* Slate 100 */
            --bg-secondary: 255 255 255;
            --bg-tertiary: 226 232 240;
            /* Slate 200 */
            --bg-card: 255 255 255;

            --text-primary: 15 23 42;
            /* Slate 900 */
            --text-muted: 51 65 85;
            /* Slate 700 */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>

<body class="bg-bg-primary text-app-text font-sans min-h-screen">

    <!-- Header -->
    <div
        class="fixed top-0 w-full z-50 backdrop-blur-xl bg-bg-primary/85 border-b border-app-text/10 px-6 py-4 flex items-center gap-4">
        <a href="javascript:history.back()"
            class="w-10 h-10 rounded-full bg-bg-card/75 border border-app-text/10 flex items-center justify-center text-app-text hover:border-accent-teal hover:-translate-x-0.5 transition-all">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <div class="text-xs text-accent-teal font-bold uppercase tracking-wider">
                <%= paper %>
            </div>
            <div class="text-xl font-bold tracking-tight text-app-text">
                <%= topic %>
            </div>
        </div>
        <div class="flex-1"></div>
        <button id="theme-toggle" onclick="toggleTheme()"
            class="w-10 h-10 rounded-full bg-bg-card/75 border border-app-text/10 flex items-center justify-center text-app-text/80 hover:border-accent-teal hover:text-accent-teal transition-all duration-200">
            <i class="fas fa-sun"></i>
        </button>
    </div>

    <!-- Main Content -->
    <div class="pt-32 pb-32 px-4 md:px-6 max-w-3xl mx-auto min-h-screen overflow-y-auto">
        <% if (questions && questions.length> 0) { %>
            <div class="space-y-6 md:space-y-8">
                <% questions.forEach((question, index)=> { %>
                    <div
                        class="bg-bg-card/50 backdrop-blur-sm border border-app-text/10 rounded-2xl p-6 shadow-xl relative overflow-hidden group hover:border-app-text/20 transition-colors">

                        <!-- Question Header -->
                        <div class="flex justify-between items-start mb-4 border-b border-app-text/10 pb-4">
                            <span class="bg-app-text/5 text-app-text/70 px-3 py-1 rounded-full text-sm font-semibold">
                                Q<%= question.questionNumber %>
                            </span>
                            <span class="text-xs font-semibold uppercase tracking-wider <%= 
                                question.difficulty === 'easy' ? 'text-accent-green' : 
                                question.difficulty === 'medium' ? 'text-accent-orange' : 
                                'text-accent-purple' 
                            %>">
                                <%= question.difficulty %>
                            </span>
                        </div>

                        <!-- Image if valid (not empty and not base64 empty) -->
                        <% if (question.imageUrl && question.imageUrl.length> 50) { %>
                            <div class="mb-4 rounded-xl overflow-hidden border border-app-text/10">
                                <img src="<%= question.imageUrl %>" alt="Question Image"
                                    class="w-full max-h-[300px] object-contain bg-black/50">
                            </div>
                            <% } %>

                                <!-- Question Text with MathJax -->
                                <div class="text-app-text/90 text-lg leading-relaxed font-medium mb-6 math-content">
                                    <%= question.questionText %>
                                </div>

                                <!-- Additional Options -->
                                <% if (question.additionalFields && question.additionalFields.length> 0) { %>
                                    <div class="space-y-2 mb-6">
                                        <% question.additionalFields.forEach(field=> { %>
                                            <div class="flex items-center gap-3">
                                                <div
                                                    class="w-6 h-6 rounded-full bg-app-text/10 flex items-center justify-center text-xs font-bold text-app-text/60">
                                                    <%= field.label || 'â€¢' %>
                                                </div>
                                                <div class="text-app-text/80">
                                                    <%= field.value %>
                                                </div>
                                            </div>
                                            <% }) %>
                                    </div>
                                    <% } %>

                                        <!-- Action Bar -->
                                        <div class="flex flex-wrap items-center justify-between mt-4 gap-4">

                                            <% if (question.timer && question.timer> 0) { %>
                                                <!-- Timer Controls -->
                                                <div class="flex items-center gap-4">
                                                    <button id="btn-start-<%= question._id %>"
                                                        onclick="startQuestion('<%= question._id %>', <%= question.timer %>)"
                                                        class="bg-accent-purple/20 hover:bg-accent-purple/30 text-accent-purple border border-accent-purple/30 px-6 py-2 rounded-xl transition-all font-bold text-sm flex items-center gap-2">
                                                        <i class="fas fa-play"></i> Start Timer
                                                    </button>
                                                    <div id="timer-badge-<%= question._id %>"
                                                        class="hidden bg-bg-card/90 border border-app-text/10 rounded-lg px-3 py-1.5 text-app-text font-mono font-medium text-sm flex items-center gap-2">
                                                        <i class="fas fa-clock text-accent-purple text-xs"></i>
                                                        <span id="timer-display-<%= question._id %>">
                                                            <%= Math.floor(question.timer / 60) %>:<%= (question.timer %
                                                                    60).toString().padStart(2, '0' ) %>
                                                        </span>
                                                    </div>
                                                </div>

                                                <!-- Done / Show Answer Button (Disabled Initially) -->
                                                <button id="btn-done-<%= question._id %>"
                                                    onclick="toggleAnswer('<%= question._id %>')" disabled
                                                    class="opacity-50 cursor-not-allowed bg-accent-teal/10 text-accent-teal border border-accent-teal/20 px-6 py-2 rounded-xl transition-all font-semibold flex items-center gap-2 text-sm z-10 relative"
                                                    title="Available after <%= Math.floor(question.timer / 2) %> seconds">
                                                    <i class="fas fa-check"></i> Done (Show Answer)
                                                </button>
                                                <% } else { %>
                                                    <!-- No Timer - Default Behavior -->
                                                    <button onclick="toggleAnswer('<%= question._id %>')"
                                                        class="bg-accent-teal/10 hover:bg-accent-teal/20 text-accent-teal border border-accent-teal/20 px-6 py-2 rounded-xl transition-all font-semibold flex items-center gap-2 text-sm z-10 relative cursor-pointer">
                                                        <i class="fas fa-eye"></i> Show Answer
                                                    </button>
                                                    <% } %>
                                                        <!-- Share Button -->
                                                        <button
                                                            onclick="shareQuestion('<%= question.questionNumber %>', '<%= topic %>')"
                                                            class="bg-app-text/5 hover:bg-app-text/10 text-app-text/60 border border-app-text/10 px-4 py-2 rounded-xl transition-all font-semibold flex items-center gap-2 text-sm z-10 relative cursor-pointer"
                                                            title="Share this question">
                                                            <i class="fas fa-share-alt"></i>
                                                        </button>
                                        </div>

                                        <!-- Hidden Answer -->
                                        <div id="answer-<%= question._id %>"
                                            class="hidden mt-6 pt-6 border-t border-app-text/10 animate-fade-in relative z-10">
                                            <h4 class="text-accent-green font-bold mb-2 flex items-center gap-2">
                                                <i class="fas fa-check-circle"></i> Correct Answer
                                            </h4>
                                            <div
                                                class="text-app-text/80 font-mono bg-bg-tertiary/50 p-4 rounded-xl border border-app-text/10 math-content">
                                                <%= question.answer %>
                                            </div>
                                        </div>

                    </div>
                    <% }) %>
            </div>
            <% } else { %>
                <div class="text-center py-20 flex flex-col items-center justify-center min-h-[50vh]">
                    <div
                        class="w-20 h-20 bg-app-text/5 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl text-app-muted">
                        <i class="fas fa-flask"></i>
                    </div>
                    <h2 class="text-xl font-bold text-app-text mb-2">No Questions Found</h2>
                    <p class="text-app-muted mb-8 max-w-sm mx-auto">We haven't added practice questions for this topic
                        yet.</p>
                    <a href="/learn"
                        class="bg-app-text/10 hover:bg-app-text/20 text-app-text px-6 py-3 rounded-xl transition-all inline-block cursor-pointer relative z-10">
                        Browse Other Topics
                    </a>
                </div>
                <% } %>
    </div>

    <script>

        const timers = {};

        function startQuestion(id, duration) {
            const startBtn = document.getElementById(`btn-start-${id}`);
            const timerBadge = document.getElementById(`timer-badge-${id}`);
            const timerDisplay = document.getElementById(`timer-display-${id}`);
            const doneBtn = document.getElementById(`btn-done-${id}`);

            // UI Updates
            startBtn.classList.add('hidden');
            timerBadge.classList.remove('hidden');

            let timeLeft = duration;
            const halfTime = duration / 2;

            // Update immediately
            updateTimerUI(timerDisplay, timeLeft);

            // Start Interval
            timers[id] = setInterval(() => {
                timeLeft--;
                updateTimerUI(timerDisplay, timeLeft);

                // Enable Done button after half time
                // Or if time is up
                if ((duration - timeLeft) >= halfTime || timeLeft <= 0) {
                    if (doneBtn.disabled) {
                        doneBtn.disabled = false;
                        doneBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        doneBtn.classList.add('hover:bg-accent-teal/20', 'cursor-pointer');
                        doneBtn.title = "Click to reveal answer";
                    }
                }

                if (timeLeft <= 0) {
                    clearInterval(timers[id]);
                    timerDisplay.parentElement.classList.add('text-accent-teal', 'font-bold');
                    timerDisplay.innerText = "0:00";

                    // Trigger Achievement Animation
                    triggerConfetti();

                    // Visual cue on the button
                    if (doneBtn) {
                        doneBtn.innerHTML = '<i class="fas fa-trophy"></i> Time Up! View Answer';
                        doneBtn.classList.remove('bg-accent-teal/10');
                        doneBtn.classList.add('bg-accent-teal', 'text-white', 'shadow-lg', 'shadow-accent-teal/40', 'animate-pulse');
                    }
                }
            }, 1000);
        }

        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function (min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function () {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                // since particles fall down, start a bit higher than random
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function updateTimerUI(el, seconds) {
            if (seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
        }

        function toggleAnswer(id) {
            const el = document.getElementById(`answer-${id}`);
            const btn = document.getElementById(`btn-done-${id}`); // Might be null if no timer, but that's fine for toggle

            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        async function shareQuestion(qNum, topic) {
            const shareData = {
                title: 'Lyro Maths Challenge',
                text: `Check out Question ${qNum} on ${topic}!`,
                url: window.location.href
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback to clipboard
                    await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
                    alert('Link copied to clipboard!');
                }
            } catch (err) {
                console.error('Error sharing:', err);
            }
        }

        // Theme Toggle Logic
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                const icon = btn.querySelector('i');
                if (theme === 'light') {
                    icon.className = 'fas fa-moon';
                } else {
                    icon.className = 'fas fa-sun';
                }
            }
        }

        // Initialize Theme
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            // Delay icon update slightly to ensure DOM is ready if script runs early
            setTimeout(() => {
                updateThemeIcon(savedTheme);
            }, 0);
        })();

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>